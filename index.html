<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Gatwick Info Bar – Fast Refresh + Persistent Last Flight</title>
<style>
  body {
    margin: 0;
    background: #00FF00; /* chroma key green screen */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .infobar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1e2a38;
    color: #ffffff;
    padding: 12px 24px;
    font-size: 1.2rem; /* Slightly larger text */
  }
  .cell {
    flex: 1;
    text-align: center;
    border-left: 1px solid rgba(255,255,255,0.2);
    padding: 4px 8px;
  }
  .cell:first-child {
    border-left: none;
    text-align: left;
    font-weight: bold;
  }
</style>
</head>
<body>
<div class="infobar">
  <div class="cell" id="airport">EGKK</div>
  <div class="cell" id="time">--:--</div>
  <div class="cell" id="temp">--°C</div>
  <div class="cell" id="callsign">Loading...</div>
  <div class="cell" id="aircraft">--</div>
  <div class="cell" id="pilot">--</div>
  <div class="cell" id="route">-- ➔ --</div>
</div>

<script>
  const el = {
    time: document.getElementById('time'),
    temp: document.getElementById('temp'),
    callsign: document.getElementById('callsign'),
    aircraft: document.getElementById('aircraft'),
    pilot: document.getElementById('pilot'),
    route: document.getElementById('route')
  };

  // Updated runway coordinates
  const runway = [
    {lat:51.1524513, lon:-0.1482916},
    {lat:51.1409245, lon:-0.2332499},
    {lat:51.1440214, lon:-0.2331188},
    {lat:51.1542142, lon:-0.1463521}
  ];

  const GAT_LAT=51.1537, GAT_LON=-0.1821, R=6371;

  function toRad(d){return d*Math.PI/180;}
  function hav(lat1,lon1,lat2,lon2){
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function pip(pt, poly){
    let inside=false;
    for(let i=0,j=poly.length-1;i<poly.length;j=i++){
      const xi=poly[i].lon,yi=poly[i].lat;
      const xj=poly[j].lon,yj=poly[j].lat;
      const intersect=((yi>pt.lat)!=(yj>pt.lat))&&(pt.lon<(xj-xi)*(pt.lat-yi)/(yj-yi)+xi);
      if(intersect)inside=!inside;
    }
    return inside;
  }

  let lastFlight = {
    callsign: 'Waiting...',
    aircraft: '--',
    pilot: '--',
    route: '-- ➔ --'
  };

  // Update time every second
  setInterval(()=>{
    const now=new Date();
    el.time.textContent = now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
  },1000);

  // Update METAR every 2 minutes
  async function updateMETAR(){
    try {
      const res = await fetch('https://metar.vatsim.net/EGKK.txt?' + Date.now());
      const text = await res.text();
      const parts = text.split(/\s+/);
      let temp = '--';
      for (const part of parts) {
        if (part.includes('/')) {
          const t = part.split('/')[0];
          temp = t.startsWith('M') ? '-' + t.substring(1) : t;
          break;
        }
      }
      el.temp.textContent = `${temp}°C`;
    } catch {
      el.temp.textContent = '--°C';
    }
  }
  updateMETAR();
  setInterval(updateMETAR,120000);

  // Update VATSIM every 3 seconds
  async function updateFlights(){
    try {
      const url = 'https://data.vatsim.net/v3/vatsim-data.json?' + Date.now();
      const data = await fetch(url).then(r=>r.json());
      const flights = data.pilots.filter(p=>{
        const fp=p.flight_plan;
        return fp&&(fp.arrival==='EGKK'||fp.departure==='EGKK')&&typeof p.latitude==='number';
      });
      flights.forEach(f=>f.d=hav(GAT_LAT,GAT_LON,f.latitude,f.longitude));
      const runwayFlights = flights.filter(f=>pip({lat:f.latitude,lon:f.longitude},runway));
      if(runwayFlights.length){
        const p=runwayFlights[0];
        const fp=p.flight_plan;
        const details = {
          callsign: p.callsign,
          aircraft: fp.aircraft.split(/[\/\s]/)[0],
          pilot: p.name || '--',
          route: fp.arrival==='EGKK' ? `${fp.departure} ➔ EGKK` : `EGKK ➔ ${fp.arrival}`
        };
        lastFlight = details; // Save this as the latest flight
        el.callsign.textContent = details.callsign;
        el.aircraft.textContent = details.aircraft;
        el.pilot.textContent = details.pilot;
        el.route.textContent = details.route;
      } else {
        // Show the last known flight if no aircraft on runway
        el.callsign.textContent = lastFlight.callsign;
        el.aircraft.textContent = lastFlight.aircraft;
        el.pilot.textContent = lastFlight.pilot;
        el.route.textContent = lastFlight.route;
      }
    } catch {
      // On error, keep last flight
      el.callsign.textContent = lastFlight.callsign;
      el.aircraft.textContent = lastFlight.aircraft;
      el.pilot.textContent = lastFlight.pilot;
      el.route.textContent = lastFlight.route;
    }
  }
  updateFlights();
  setInterval(updateFlights,3000); // 3 seconds refresh
</script>
</body>
</html>
