<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Gatwick Runway Highlighted Flight - Animated</title>
<style>
  body {
    margin: 0; 
    height: 100vh;
    background-color: #008000; /* green background */
    display: flex;
    justify-content: center;
    align-items: flex-end;
    font-family: sans-serif;
    overflow: hidden;
  }
  #flight-box {
    background-color: #555555; /* gray box */
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    max-width: 90vw;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  #flight-box.hidden {
    opacity: 0;
    transform: translateY(30px);
  }
</style>
</head>
<body>
  <div id="flight-box"></div>

<script>
  const runwayPolygon = [
    {lat: 51.1518258, lon: -0.1660981},
    {lat: 51.1511402, lon: -0.1658671},
    {lat: 51.1447597, lon: -0.2121570},
    {lat: 51.1454248, lon: -0.2123059}
  ];

  const GATWICK_LAT = 51.1537;
  const GATWICK_LON = -0.1821;

  function toRad(deg) { return deg * Math.PI / 180; }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function pointInPolygon(point, polygon) {
    let inside = false;
    for(let i = 0, j = polygon.length -1; i < polygon.length; j = i++) {
      const xi = polygon[i].lon, yi = polygon[i].lat;
      const xj = polygon[j].lon, yj = polygon[j].lat;
      const intersect = ((yi > point.lat) != (yj > point.lat)) &&
                        (point.lon < (xj - xi) * (point.lat - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }

  const box = document.getElementById('flight-box');
  let currentText = '';

  async function fetchHighlightedFlight() {
    // Animate out
    box.classList.add('hidden');

    try {
      const res = await fetch("https://data.vatsim.net/v3/vatsim-data.json");
      const data = await res.json();

      const pilots = data.pilots;

      const flights = pilots.filter(p => {
        const fp = p.flight_plan;
        return fp &&
          (fp.arrival === "EGKK" || fp.departure === "EGKK") &&
          typeof p.latitude === "number" &&
          typeof p.longitude === "number";
      });

      if (flights.length === 0) {
        updateText("No Gatwick traffic currently.");
        return;
      }

      flights.forEach(f => {
        f.distanceToGatwick = haversine(GATWICK_LAT, GATWICK_LON, f.latitude, f.longitude);
      });

      const planesOnRunway = flights.filter(f => pointInPolygon({lat: f.latitude, lon: f.longitude}, runwayPolygon));

      if (planesOnRunway.length === 0) {
        updateText("No plane currently on runway.");
        return;
      }

      const runwayPlane = planesOnRunway.reduce((closest, p) => {
        return p.distanceToGatwick < closest.distanceToGatwick ? p : closest;
      }, planesOnRunway[0]);

      const fp = runwayPlane.flight_plan;
      const pilotName = runwayPlane.name || "Unknown Pilot";
      const rawAircraft = fp.aircraft || "Unknown Type";
      const aircraft = rawAircraft.split(/[\/\s]/)[0];

      const text = fp.arrival === "EGKK"
        ? `${runwayPlane.callsign} inbound to Gatwick from ${fp.departure} — Aircraft: ${aircraft} — Pilot: ${pilotName}`
        : `${runwayPlane.callsign} outbound from Gatwick to ${fp.arrival} — Aircraft: ${aircraft} — Pilot: ${pilotName}`;

      updateText(text);
    } catch (e) {
      updateText("Error fetching data.");
      console.error(e);
    }
  }

  function updateText(newText) {
    if (newText === currentText) {
      // No change, just fade back in
      box.classList.remove('hidden');
      return;
    }
    // Wait for fade-out transition (400ms)
    setTimeout(() => {
      box.textContent = newText;
      currentText = newText;
      box.classList.remove('hidden');
    }, 400);
  }

  fetchHighlightedFlight();
  setInterval(fetchHighlightedFlight, 30000);
</script>
</body>
</html>

