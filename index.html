<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Gatwick Info Bar – VATSIM METAR Temp</title>
<style>
  body {
    margin: 0;
    background: #00FF00; /* chroma key */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .infobar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1e2a38;
    color: #ffffff;
    padding: 10px 20px;
    font-size: 1rem;
  }
  .cell {
    flex: 1;
    text-align: center;
    border-left: 1px solid rgba(255,255,255,0.2);
    padding: 4px 8px;
  }
  .cell:first-child {
    border-left: none;
    text-align: left;
    font-weight: bold;
  }
</style>
</head>
<body>
<div class="infobar">
  <div class="cell" id="airport">EGKK</div>
  <div class="cell" id="time">--:--</div>
  <div class="cell" id="temp">--°C</div>
  <div class="cell" id="callsign">Loading...</div>
  <div class="cell" id="aircraft">--</div>
  <div class="cell" id="reg">--</div>
  <div class="cell" id="route">-- ➔ --</div>
</div>

<script>
  const el = {
    time: document.getElementById('time'),
    temp: document.getElementById('temp'),
    callsign: document.getElementById('callsign'),
    aircraft: document.getElementById('aircraft'),
    reg: document.getElementById('reg'),
    route: document.getElementById('route')
  };

  const runway = [
    {lat:51.1518258, lon:-0.1660981},
    {lat:51.1511402, lon:-0.1658671},
    {lat:51.1447597, lon:-0.2121570},
    {lat:51.1454248, lon:-0.2123059}
  ];
  const GAT_LAT=51.1537, GAT_LON=-0.1821, R=6371;

  function toRad(d){return d*Math.PI/180;}
  function hav(lat1,lon1,lat2,lon2){
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function pip(pt, poly){
    let inside=false;
    for(let i=0,j=poly.length-1;i<poly.length;j=i++){
      const xi=poly[i].lon,yi=poly[i].lat;
      const xj=poly[j].lon,yj=poly[j].lat;
      const intersect=((yi>pt.lat)!=(yj>pt.lat))&&(pt.lon<(xj-xi)*(pt.lat-yi)/(yj-yi)+xi);
      if(intersect)inside=!inside;
    }
    return inside;
  }

  async function update() {
    // Time
    const now = new Date();
    el.time.textContent = now.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });

    // METAR temperature
    try {
      const res = await fetch('https://metar.vatsim.net/EGKK.txt');
      const text = await res.text();
      const parts = text.split(/\s+/);
      let temp = null;
      
      for (const part of parts) {
        if (/^(M?\d{1,2})\/(M?\d{1,2})$/.test(part)) {
          const match = part.match(/^(M?\d{1,2})/);
          if (match) {
            temp = match[1].replace('M', '-');
            break;
          }
        }
      }
      
      if (temp !== null) {
        el.temp.textContent = `${temp}°C`;
      } else {
        el.temp.textContent = '--°C';
      }
      
          } catch {
            el.temp.textContent = '--°C';
          }

    // VATSIM flight
    try {
      const data = await fetch('https://data.vatsim.net/v3/vatsim-data.json').then(r=>r.json());
      const flights = data.pilots.filter(p=>{
        const fp=p.flight_plan;
        return fp&&(fp.arrival==='EGKK'||fp.departure==='EGKK')&&typeof p.latitude==='number';
      });
      flights.forEach(f=>f.d=hav(GAT_LAT,GAT_LON,f.latitude,f.longitude));
      const runwayFlights = flights.filter(f=>pip({lat:f.latitude,lon:f.longitude},runway));
      if(runwayFlights.length){
        const p=runwayFlights[0];
        const fp=p.flight_plan;
        el.callsign.textContent = p.callsign;
        el.aircraft.textContent = fp.aircraft.split(/[\/\s]/)[0];
        el.reg.textContent = p.registration||'--';
        el.route.textContent = fp.arrival==='EGKK' ? `${fp.departure} ➔ EGKK` : `EGKK ➔ ${fp.arrival}`;
      } else {
        el.callsign.textContent='No runway traffic';
        el.aircraft.textContent='--';
        el.reg.textContent='--';
        el.route.textContent='-- ➔ --';
      }
    } catch {
      el.callsign.textContent='Flight error';
    }
  }

  update();
  setInterval(update,30000);
</script>
</body>
</html>
