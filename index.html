<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Gatwick Info Bar – METAR Only</title>
<style>
  body {
    margin: 0;
    background: #00FF00; /* chroma key green screen */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .infobar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1e2a38;
    color: #ffffff;
    padding: 10px 20px;
    font-size: 1rem;
  }
  .cell {
    flex: 1;
    text-align: center;
    border-left: 1px solid rgba(255,255,255,0.2);
    padding: 4px 8px;
  }
  .cell:first-child {
    border-left: none;
    text-align: left;
    font-weight: bold;
  }
</style>
</head>
<body>
<div class="infobar">
  <div class="cell" id="airport">EGKK</div>
  <div class="cell" id="time">--:--</div>
  <div class="cell" id="temp">--°C</div>
  <div class="cell" id="callsign">Loading...</div>
  <div class="cell" id="aircraft">--</div>
  <div class="cell" id="pilot">--</div>
  <div class="cell" id="route">-- ➔ --</div>
</div>

<script>
  const el = {
    time: document.getElementById('time'),
    temp: document.getElementById('temp'),
    callsign: document.getElementById('callsign'),
    aircraft: document.getElementById('aircraft'),
    pilot: document.getElementById('pilot'),
    route: document.getElementById('route')
  };

  const runway = [
    {lat:51.1518258, lon:-0.1660981},
    {lat:51.1511402, lon:-0.1658671},
    {lat:51.1447597, lon:-0.2121570},
    {lat:51.1454248, lon:-0.2123059}
  ];
  const GAT_LAT=51.1537, GAT_LON=-0.1821, R=6371;

  function toRad(d){return d*Math.PI/180;}
  function hav(lat1,lon1,lat2,lon2){
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function pip(pt, poly){
    let inside=false;
    for(let i=0,j=poly.length-1;i<poly.length;j=i++){
      const xi=poly[i].lon,yi=poly[i].lat;
      const xj=poly[j].lon,yj=poly[j].lat;
      const intersect=((yi>pt.lat)!=(yj>pt.lat))&&(pt.lon<(xj-xi)*(pt.lat-yi)/(yj-yi)+xi);
      if(intersect)inside=!inside;
    }
    return inside;
  }

  // Update time every second
  setInterval(()=>{
    const now=new Date();
    el.time.textContent = now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
  },1000);

  // Update METAR every 2 minutes
  async function updateMETAR(){
    try {
      const res = await fetch('https://metar.vatsim.net/EGKK.txt');
      const text = await res.text();
      const parts = text.split(/\s+/);
      let temp = '--';
      for (const part of parts) {
        if (part.includes('/')) {
          const t = part.split('/')[0];
          temp = t.startsWith('M') ? '-' + t.substring(1) : t;
          break;
        }
      }
      el.temp.textContent = `${temp}°C`;
    } catch {
      el.temp.textContent = '--°C';
    }
  }
  updateMETAR();
  setInterval(updateMETAR,120000);

  // Update VATSIM every 5 seconds
  async function updateFlights(){
    try {
      const data = await fetch('https://data.vatsim.net/v3/vatsim-data.json').then(r=>r.json());
      const flights = data.pilots.filter(p=>{
        const fp=p.flight_plan;
        return fp&&(fp.arrival==='EGKK'||fp.departure==='EGKK')&&typeof p.latitude==='number';
      });
      flights.forEach(f=>f.d=hav(GAT_LAT,GAT_LON,f.latitude,f.longitude));
      const runwayFlights = flights.filter(f=>pip({lat:f.latitude,lon:f.longitude},runway));
      if(runwayFlights.length){
        const p=runwayFlights[0];
        const fp=p.flight_plan;
        el.callsign.textContent = p.callsign;
        el.aircraft.textContent = fp.aircraft.split(/[\/\s]/)[0];
        el.pilot.textContent = p.name || '--';
        el.route.textContent = fp.arrival==='EGKK' ? `${fp.departure} ➔ EGKK` : `EGKK ➔ ${fp.arrival}`;
      } else {
        el.callsign.textContent='No runway traffic';
        el.aircraft.textContent='--';
        el.pilot.textContent='--';
        el.route.textContent='-- ➔ --';
      }
    } catch {
      el.callsign.textContent='Flight error';
      el.aircraft.textContent='--';
      el.pilot.textContent='--';
      el.route.textContent='-- ➔ --';
    }
  }
  updateFlights();
  setInterval(updateFlights,5000);
</script>
</body>
</html>

